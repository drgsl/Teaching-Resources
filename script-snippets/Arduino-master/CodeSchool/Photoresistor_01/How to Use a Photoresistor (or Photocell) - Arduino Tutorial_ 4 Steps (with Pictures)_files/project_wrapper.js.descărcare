window.codebender.projectWrapper.projectWrapperEngine={CLONE_BUTTON_UNSAVED_CHANGES_MESSAGE:"You have made changes that will not be included into your cloned project",DOWNLOAD_BUTTON_UNSAVED_CHANGES_MESSAGE:"You have made changes that will not be included into your download",SIDEBAR_WIDTH:200,COMPILE_OUTPUT_HEIGHT:200,iframeFlag:false,sidebarOpenFlag:false,loadedFiles:{},initialize:function(){this.$fileList=$("#file_list");this.$editButton=$("#edit-button");this.$projectName=$(".projectName");this.$userName=$(".userName");this.$downloadLink=$(".download-link");this.$cloneLink=$(".clone-link");this.$sidebarToggle=$("#sidebar-toggle");this.$codebenderEmbedWrapper=$("#codeBender_embed_wrapper");this.$codebenderEmbedHeader=$("#codeBender_embed_header");this.$codebenderEmbedFooter=$("#codeBender_embed_footer");this.$codeBenderEmbedSidebar=$("#codeBender_embed_sidebar");this.$codebenderEmbedCodeContainer=$("#codeBender_embed_codeContainer");this.$codebenderEmbedCodeWrapper=$("#codeBender_embed_codeWrapper");this.$compileOuputContainer=$("#compile-output-container");this.detectDevice();this.checkIframeParent();this.registerHashChangeEvent();this.input=JSON.parse(window.codebender.projectWrapper.json);this.initializeFilelist();this.initializeEditorAndFilemanager();this.initializeCompilerflasher();this.initializeUi();this.initializeSidebar();this.intializeReferrer();this.startEventListeners();this.startTouchEventListeners();this.initialHashChange()},checkIframeParent:function(){var checkIframe=window.location!=window.parent.location;if(checkIframe){var parentReferrer=document.referrer;var host=window.codebender.schemeAndhttpHost;if(parentReferrer.indexOf(host)==0){this.iframeFlag=true}}},registerHashChangeEvent:function(){var self=this;if(this.iframeFlag){var hash;$(window).on("hashchange",function(){hash=$.param.fragment();window.parent.location.hash=hash;$(window.parent).trigger("hashchange")});$(window.parent).on("hashchange",function(){hash=$.param.fragment();if(hash){self.selectFile(decodeURIComponent(hash))}});return}$(window).on("hashchange",function(){var hash=$.param.fragment();if(hash){self.selectFile(decodeURIComponent(hash))}})},initializeFilelist:function(){var self=this;var files=this.input.files;files.sort(function(a,b){return String.naturalCompare(a.filename.toLowerCase(),b.filename.toLowerCase())});var fileList=[];var inoRegExp=/^.+\.ino$/;var filename;var $divTag;for(var i=0;i<files.length;i++){filename=files[i].filename;self.loadedFiles[filename]=files[i].code;$divTag=this.createFileElement(filename,i);if(inoRegExp.test(filename)){this.$fileList.prepend($divTag);fileList.splice(0,0,filename)}else{this.$fileList.append($divTag);fileList.push(filename)}}this.fileList=fileList},createFileElement:function(filename,fileCounter){var $div=$("<div>");$div.addClass("file");$div.attr("for","codeBender_embed_file"+fileCounter);$div.attr("data-name",filename);var $span=$("<span>");$span.addClass("name");$span.text(filename);$div.append($span);return $div},initializeEditorAndFilemanager:function(){var inProjectView=true;window.editor=new editor("codeBender_embed_codeWrapper",this.loadedFiles,inProjectView);editor.setReadOnly(true);window.fileManager=new fileManager(this.loadedFiles)},initializeCompilerflasher:function(){var self=this;var initInterval=setInterval(function(){if(!window.compilerflasherStart){return}clearInterval(initInterval);window.compilerflasher=new compilerflasher(function(){return fileManager.getFiles()});compilerflasher.embedded=true;compilerflasher.selectedProgrammer={communication:"",delay:"0",force:"false",name:"USBtinyISP",protocol:"usbtiny",speed:"0"};compilerflasher.on("plugin_running",function(){compilerflasher.setOperationOutput("Select your device, the correct port, and click Run.")});compilerflasher.on("pre_flash",function(){self.compileOutputClose();before_flash()});compilerflasher.on("verification_failed",function(message){verification_onFail(message);self.compileOutputOpen();self.compilerflasherVerificationFailedHandler()})},50)},compilerflasherVerificationFailedHandler:function(){var savedState=fileManager.savedState;var currentState=fileManager.getFiles();if(!checkObjEquals(savedState,currentState)){var actionId=88;var metaData={edited:true};createLog(actionId,metaData)}},initializeUi:function(){var input=this.input;var type="sketch";if(window.codebender.projectWrapper.type=="example"){type="example"}this.type=type;var viewName;switch(window.codebender.projectWrapper.type){case"library":viewName="system_"+input["project"].name;break;case"personallibrary":viewName="personal_"+input["project"].name;break;default:viewName="";break}window.name=viewName;var $projectNameAnchor=$("<a>");var projectNameHref=input["project"].url;if(type=="example"){if(window.codebender.projectWrapper.exampleWithSubcategory){projectNameHref=window.codebender.projectWrapper.exampleWithSubcategory}else{projectNameHref=window.codebender.projectWrapper.example}}$projectNameAnchor.attr("href",projectNameHref);$projectNameAnchor.text(input["project"].name);this.$projectName.html($projectNameAnchor);var $userNameAnchor=$("<a>");$userNameAnchor.attr("href",input["user"].url);$userNameAnchor.text(input["user"].name);this.$userName.html($userNameAnchor);var cloneButtonHref;if(window.codebender.projectWrapper.roleUser){if(type=="example"){cloneButtonHref=window.codebender.projectWrapper.cloneExample}else{this.$cloneLink.attr("href",input["clone_url"]);cloneButtonHref=input["clone_url"]}}else{cloneButtonHref=window.codebender.projectWrapper.index;this.$cloneLink.addClass("clone-link-inactive").attr("title","Sign up to clone!").tooltip({placement:"bottom"})}this.$cloneLink.attr("href",cloneButtonHref);this.$downloadLink.attr("href",this.input["download_url"])},initializeSidebar:function(){var files=Object.keys(fileManager.getFiles());if(files.length>1){this.sidebarToggle();return}this.$sidebarToggle.remove()},intializeReferrer:function(){var queryParameters={};(window.onpopstate=function(){var match;var search=/([^&=]+)=?([^&]*)/g;var query=window.location.search.substring(1);while(match=search.exec(query)){queryParameters[match[1]]=match[2]}})();if(!queryParameters.hasOwnProperty("referrer")){if(!(window.codebender.projectWrapper.type=="example")){queryParameters.referrer=this.input["user"]["name"]}}var queryStringArray=[];Object.keys(queryParameters).forEach(function(parameter){queryStringArray.push(parameter+"="+queryParameters[parameter])});var queryString=queryStringArray.join("&");if(queryString&&queryString!=="referrer="){this.$cloneLink.attr("href",this.$cloneLink.attr("href")+"?"+queryString);this.$downloadLink.attr("href",this.$downloadLink.attr("href")+"?"+queryString);this.$projectName.find("a").attr("href",this.$projectName.find("a").attr("href")+"?"+queryString);this.$userName.find("a").attr("href",this.$userName.find("a").attr("href")+"?"+queryString)}},startEventListeners:function(){var self=this;this.$fileList.on("click",".file",function(){var filename=$(this).attr("data-name");self.changeHash(filename)});this.$sidebarToggle.on("click",this.sidebarToggle.bind(this));this.$editButton.on("click",function(){if(window.editorReadOnly){$(this).attr("title","Restore "+self.type+" to its original state").tooltip("fixTitle");$(this).html('<i class="icon-undo"></i> Restore');editor.setReadOnly(false)}else{var fileList=fileManager.savedState;Object.keys(fileList).forEach(function(fname){fileManager.setContent(fname,fileList[fname])});fileManager.openFile(fileManager.openFname);$(this).attr("title","Temporarily edit the "+self.type).tooltip("fixTitle");$(this).html('<i class="icon-edit"></i> Edit');editor.setReadOnly(true);self.compileOutputClose()}}).tooltip({placement:"bottom",title:"Temporarily edit the "+this.type});this.$cloneLink.on("click",function(){var savedState=fileManager.savedState;var currentState=fileManager.getFiles();if(!checkObjEquals(savedState,currentState)){alert(self.CLONE_BUTTON_UNSAVED_CHANGES_MESSAGE)}});this.$downloadLink.on("click",function(){var savedState=fileManager.savedState;var currentState=fileManager.getFiles();if(!checkObjEquals(savedState,currentState)){alert(self.DOWNLOAD_BUTTON_UNSAVED_CHANGES_MESSAGE)}});$("#compile-output-close-button").on("click",function(){self.compileOutputClose()});Mousetrap.bindGlobal("mod",function(){$(window).trigger("library_search_on")},"keydown");Mousetrap.bindGlobal("mod",function(){$(window).trigger("library_search_off")},"keyup")},startTouchEventListeners:function(){var xStart;var yStart;var xStop;var yStop;var x;var y;editor.aceEditor.container.addEventListener("touchstart",function(event){xStart=event.targetTouches.item(0).clientX;yStart=event.targetTouches.item(0).clientY});editor.aceEditor.container.addEventListener("touchmove",function(event){if(event.targetTouches.length>1){return}xStop=event.targetTouches.item(0).clientX;yStop=event.targetTouches.item(0).clientY;x=xStart-xStop;y=yStart-yStop;xStart=xStop;yStart=yStop;if(editor.aceEditor.renderer.isScrollableBy(x,y)){event.preventDefault();editor.aceEditor.renderer.scrollBy(x,y)}})},initialHashChange:function(){if(this.fileList.length==1){this.selectFile(this.fileList[0]);return}var hash=null;if(this.iframeFlag){hash=window.parent.location.hash}else{hash=$.param.fragment()}var disqusRegExp=/comment-\d+/;if(disqusRegExp.test(hash)){var doNotChangeHash=true;this.selectFile(this.fileList[0],doNotChangeHash);return}if(hash){if(this.iframeFlag){$.bbq.pushState(hash,2)}else{$(window).trigger("hashchange")}return}hash=encodeURIComponent(this.fileList[0]);$.bbq.pushState(hash,2)},getWindowHeight:function(){var codebenderEmbedWrapperHeight=parseInt(this.$codebenderEmbedWrapper.css("height"),10);var codebenderEmbedHeaderHeight=parseInt(this.$codebenderEmbedHeader.css("height"),10);var codebenderEmbedFooterHeight=parseInt(this.$codebenderEmbedFooter.css("height"),10);return codebenderEmbedWrapperHeight-codebenderEmbedHeaderHeight-codebenderEmbedFooterHeight},selectFile:function(file,doNotChangeHash){if(file==fileManager.openFname){return}var $file=this.$fileList.find(".file");$file.removeClass("file-selected");var self=this;$file.each(function(key,value){if($(this).attr("data-name")==file){$(this).addClass("file-selected");var top=$(value).position().top;if(top>=0&&top<=self.getWindowHeight()){return}var animateConfig={scrollTop:self.$codeBenderEmbedSidebar.scrollTop()-Math.abs(top)};if(top>0){animateConfig={scrollTop:top}}self.$codeBenderEmbedSidebar.animate(animateConfig,500)}});this.logFile(file);fileManager.openFile(file);editor.aceEditor.resize(true);editor.aceEditor.renderer.scrollToY(0);editor.aceEditor.renderer.scrollToX(-1);if(!doNotChangeHash){this.changeHash(file)}},changeHash:function(file){var hash=encodeURIComponent(file);$.bbq.pushState(hash,2)},sidebarToggle:function(){if(this.sidebarOpenFlag){this.sidebarClose()}else{this.sidebarOpen()}if(this.sidebarOpenFlag){this.$sidebarToggle.attr("src",window.codebender.projectWrapper.sidebarClose)}else{this.$sidebarToggle.attr("src",window.codebender.projectWrapper.sidebarOpen)}},sidebarOpen:function(){var self=this;function sidebarCallback(){var files=self.$fileList.find("> .file > .name");var maxWidth=self.SIDEBAR_WIDTH;$.each(files,function(key,value){var width=$(value).width();if(width>maxWidth){maxWidth=width}});maxWidth=maxWidth+"px";self.$fileList.find("> .file").css({"min-width":maxWidth})}var sidebarWidth=this.SIDEBAR_WIDTH+"px";var editorLeft=this.SIDEBAR_WIDTH;this.sidebarHandler(sidebarWidth,editorLeft,sidebarCallback);this.sidebarOpenFlag=true},sidebarClose:function(){var sidebarWidth=0;var editorLeft=0;this.sidebarHandler(sidebarWidth,editorLeft);this.sidebarOpenFlag=false},sidebarHandler:function(sidebarWidth,editorLeft,sidebarCallback){var sidebarDeferred=$.Deferred();this.$codeBenderEmbedSidebar.animate({width:sidebarWidth},400,function(){if(typeof sidebarCallback==="function"){sidebarCallback()}sidebarDeferred.resolve()});var editorDeferred=$.Deferred();this.$codebenderEmbedCodeContainer.animate({left:editorLeft},400,function(){editorDeferred.resolve()});$.when(sidebarDeferred,editorDeferred).then(function(){editor.aceEditor.resize()})},compileOutputOpen:function(){var codeWrapperHeight=this.$codebenderEmbedCodeContainer.height()-this.COMPILE_OUTPUT_HEIGHT+"px";var compileOutputHeight=this.COMPILE_OUTPUT_HEIGHT+"px";this.compileOutputHandler(codeWrapperHeight,compileOutputHeight)},compileOutputClose:function(){var codeWrapperHeight=this.$codebenderEmbedCodeContainer.height()+"px";var compileOutputHeight=0;this.compileOutputHandler(codeWrapperHeight,compileOutputHeight);fileManager.clearAnnotations();fileManager.removeAllMarkers()},compileOutputHandler:function(codeWrapperHeight,compileOutputHeight){var codeWrapperDeferred=$.Deferred();this.$codebenderEmbedCodeWrapper.animate({height:codeWrapperHeight},400,function(){codeWrapperDeferred.resolve()});var compileOutputDeferred=$.Deferred();this.$compileOuputContainer.animate({height:compileOutputHeight},400,function(){compileOutputDeferred.resolve()});$.when(codeWrapperDeferred,compileOutputDeferred).then(function(){editor.aceEditor.resize()})},logFile:function(file){var actionId;var metaData;var type;switch(window.codebender.projectWrapper.type){case"library":actionId=77;type="system";metaData={Library:window.codebender.projectWrapper.library,File:file,"Library Type":type};break;case"personallibrary":actionId=77;type="personal";metaData={Library:window.codebender.projectWrapper.library,File:file,"Library Type":type};break;case"example":actionId=79;metaData={Library:window.codebender.projectWrapper.library,File:file};break;default:actionId=80;var jsonData=JSON.parse(window.codebender.projectWrapper.json);var projectId;try{var projectUrl=jsonData.project.url.split(":");projectId=projectUrl[projectUrl.length-1]}catch(error){projectId=null}var projectName;try{projectName=jsonData.project.name}catch(error){projectName=null}metaData={"Project ID":projectId,"Project Name":projectName,File:file};break}createLog(actionId,metaData)},detectDevice:function(){var touchSupport="no-touch";if("ontouchstart"in document.documentElement){touchSupport="touch"}this.$codebenderEmbedCodeWrapper.addClass(touchSupport);if(touchSupport=="no-touch"){this.$codebenderEmbedCodeContainer.css({"-webkit-overflow-scrolling":"touch"})}}};function selectFile(filename){window.codebender.projectWrapper.projectWrapperEngine.selectFile(filename)}$(document).ready(function(){window.codebender.projectWrapper.projectWrapperEngine.initialize()});